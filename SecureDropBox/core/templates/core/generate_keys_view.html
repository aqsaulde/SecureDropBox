<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <link href="{% static 'core/styles.css' %}" rel="stylesheet" />
    <!-- In <head> -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Before </body> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .modal#statusSuccessModal .modal-content,
      .modal#statusErrorsModal .modal-content {
        border-radius: 30px;
      }
      .modal#statusSuccessModal .modal-content svg,
      .modal#statusErrorsModal .modal-content svg {
        width: 100px;
        display: block;
        margin: 0 auto;
      }
      .modal#statusSuccessModal .modal-content .path,
      .modal#statusErrorsModal .modal-content .path {
        stroke-dasharray: 1000;
        stroke-dashoffset: 0;
      }
      .modal#statusSuccessModal .modal-content .path.circle,
      .modal#statusErrorsModal .modal-content .path.circle {
        -webkit-animation: dash 0.9s ease-in-out;
        animation: dash 0.9s ease-in-out;
      }
      .modal#statusSuccessModal .modal-content .path.line,
      .modal#statusErrorsModal .modal-content .path.line {
        stroke-dashoffset: 1000;
        -webkit-animation: dash 0.95s 0.35s ease-in-out forwards;
        animation: dash 0.95s 0.35s ease-in-out forwards;
      }
      .modal#statusSuccessModal .modal-content .path.check,
      .modal#statusErrorsModal .modal-content .path.check {
        stroke-dashoffset: -100;
        -webkit-animation: dash-check 0.95s 0.35s ease-in-out forwards;
        animation: dash-check 0.95s 0.35s ease-in-out forwards;
      }

      @-webkit-keyframes dash {
        0% {
          stroke-dashoffset: 1000;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @keyframes dash {
        0% {
          stroke-dashoffset: 1000;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @-webkit-keyframes dash {
        0% {
          stroke-dashoffset: 1000;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @keyframes dash {
        0% {
          stroke-dashoffset: 1000;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @-webkit-keyframes dash-check {
        0% {
          stroke-dashoffset: -100;
        }
        100% {
          stroke-dashoffset: 900;
        }
      }
      @keyframes dash-check {
        0% {
          stroke-dashoffset: -100;
        }
        100% {
          stroke-dashoffset: 900;
        }
      }
      .box00 {
        width: 100px;
        height: 100px;
        border-radius: 50%;
      }
      ul.horizontal {
        display: flex;
        flex-wrap: wrap;
        list-style: none;
        padding-left: 0;
        gap: 10px;
      }

      ul.horizontal li {
        flex: 0 0 150px;
        background: #fff;
        padding: 8px;
        text-align: center;
        border-radius: 4px;
      }
      @keyframes dash {
        0% {
          stroke-dashoffset: 1000;
        }
        100% {
          stroke-dashoffset: 0;
        }
      }
      @-webkit-keyframes dash-check {
        0% {
          stroke-dashoffset: -100;
        }
        100% {
          stroke-dashoffset: 900;
        }
      }
      @keyframes dash-check {
        0% {
          stroke-dashoffset: -100;
        }
        100% {
          stroke-dashoffset: 900;
        }
      }
      .box00 {
        width: 100px;
        height: 100px;
        border-radius: 50%;
      }
      ul.horizontal {
        display: flex;
        flex-wrap: wrap;
        list-style: none;
        padding-left: 0;
        gap: 10px;
      }

      ul.horizontal li {
        flex: 0 0 150px;
        background: #fff;
        padding: 8px;
        text-align: center;
        border-radius: 4px;
      }
      /* Style file inputs */
      .file-input {
        width: 100%;
        padding: 8px;
        border: 2px dashed #ccc;
        border-radius: 6px;
        cursor: pointer;
        transition: border-color 0.3s ease;
        font-family: Arial, sans-serif;
      }

      .file-input:hover,
      .file-input:focus {
        border-color: #007bff;
        outline: none;
      }

      /* Optional: Style labels */
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 6px;
        font-family: Arial, sans-serif;
      }

      /* Wrap fields for spacing */
      .form-group {
        margin-bottom: 18px;
      }
    </style>
    <title>Generate Keys | SecureDropBox</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <!-- Navbar -->
    <nav class="bg-white shadow-md px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ðŸ”’</span>
        <h1 class="text-xl font-bold text-blue-600">SecureDropBox</h1>
      </div>
      <ul class="horizontal">
        <li>
          <a class="text-black" href="{% url 'dashboard' %}">ðŸ“Š Dashboard</a>
        </li>
        <li>
          <a class="nav-link text-black" href="{% url 'generate_keys' %}"
            >ðŸ”‘ Key Generator</a
          >
        </li>
        <li>
          <a class="nav-link text-black" href="{% url 'encryption' %}"
            >ðŸ”’ Encryption</a
          >
        </li>
        <li>
          <a class="nav-link text-black" href="{% url 'decryption' %}"
            >ðŸ”“ Decryption</a
          >
        </li>
        <!-- Add more links as needed -->
      </ul>
      <div class="relative group">
        <img
          src="https://api.dicebear.com/7.x/initials/svg?seed={{ user.username }}"
          alt="Profile"
          class="w-10 h-10 rounded-full cursor-pointer"
        />
        <h2 class="font-light mb-2 text-gray-800">
          Welcome,
          <span class="text-blue-600 font-bold">{{ user.username }}</span>
        </h2>
        <div
          class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden group-hover:block"
        >
          <a
            href="{% url 'settings' %}"
            class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
            >Settings</a
          >
           <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
             <button type="submit" class="text-start block px-4 py-2 text-gray-700 hover:bg-gray-100 w-100">Logout</button>
          </form>
        </div>
      </div>
    </nav>
    <!-- Main Container -->
    <div class="max-w-5xl mx-auto mt-10 bg-white p-8 rounded shadow-lg">
      <div class="container">
        <h1><b>Generate RSA Keys</b></h1>
        <form method="post">
          {% csrf_token %} {{ form.as_p }}
          <button
            type="submit"
            class="focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 mt-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800"
          >
            Generate New Keys
          </button>
        </form>
        <h2 class="mt-4 mb-4"><b>User RSA Key Pairs</b></h2>
        {% if messages %} 
        {% for message in messages %}
         {% if message.tags == 'error' %}
        <div class="alert alert-danger">
          {% endif %}
           {% if message.tags == 'success' %}
          <div class="alert alert-success">
            {% endif %} 
            {{message}}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          {% endfor %} 
          {% endif %}
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>#</th>
                <th>User</th>
                <th>Key_ID</th>
                <th>Key Name</th>
                <th>Key Size</th>
                <th>Created At</th>
                <th>Public Key</th>
                <th>Private Key</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for key in keys %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ key.user.username }}</td>
                <td>{{ key.key_id }}</td>
                <td>{{ key.key_name }}</td>
                <td>{{ key.key_size }}</td>
                <td>{{ key.created_at }}</td>

                <td>
                  <a
                    href="{% url 'download_key' key.key_id 'private' %}"
                    class="btn btn-success btn-sm"
                    >Download Key</a
                  >
                </td>
                <td>
                  <a
                    href="{% url 'download_key' key.key_id 'private' %}"
                    class="btn btn-success btn-sm"
                    >Download Key</a
                  >
                </td>
                <td>
                  <button
                    class="btn btn-danger btn-sm mb-2"
                    data-bs-toggle="modal"
                    data-bs-target="#statusErrorsModal"
                    data-key-id="{{ key.key_id }}"
                  >
                    Delete
                  </button>
                  <button
                    class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#shareKeyModal"
                    data-key-id="{{ key.key_id }}"
                  >
                    Share via Email
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center">No keys found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="statusSuccessModal"
      tabindex="-1"
      role="dialog"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-body text-center p-lg-4">
            <svg
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 130.2 130.2"
            >
              <circle
                class="path circle"
                fill="none"
                stroke="#198754"
                stroke-width="6"
                stroke-miterlimit="10"
                cx="65.1"
                cy="65.1"
                r="62.1"
              />
              <polyline
                class="path check"
                fill="none"
                stroke="#198754"
                stroke-width="6"
                stroke-linecap="round"
                stroke-miterlimit="10"
                points="100.2,40.2 51.5,88.8 29.8,67.5 "
              />
            </svg>
            <p class="mt-3">{{ message }}</p>
            <button
              type="button"
              class="btn btn-sm mt-3 btn-success"
              data-bs-dismiss="modal"
            >
              Ok
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="statusErrorsModal"
      tabindex="-1"
      role="dialog"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
    >
      <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <form method="POST" id="deleteForm">
          {% csrf_token %}
          <div class="modal-content">
            <div class="modal-body text-center p-lg-4">
              <svg
                version="1.1"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 130.2 130.2"
              >
                <circle
                  class="path circle"
                  fill="none"
                  stroke="#db3646"
                  stroke-width="6"
                  stroke-miterlimit="10"
                  cx="65.1"
                  cy="65.1"
                  r="62.1"
                />
                <line
                  class="path line"
                  fill="none"
                  stroke="#db3646"
                  stroke-width="6"
                  stroke-linecap="round"
                  stroke-miterlimit="10"
                  x1="34.4"
                  y1="37.9"
                  x2="95.8"
                  y2="92.3"
                />
                <line
                  class="path line"
                  fill="none"
                  stroke="#db3646"
                  stroke-width="6"
                  stroke-linecap="round"
                  stroke-miterlimit="10"
                  x1="95.8"
                  y1="38"
                  X2="34.4"
                  y2="92.2"
                />
              </svg>
              <h4 class="text-danger mt-3">Delete Keys</h4>
              <p class="mt-3">Are you sure you want to perform this action.</p>
              <button
                type="button"
                class="btn btn-sm mt-3 btn-danger"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-sm mt-3 btn-danger">
                Delete
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Share Key Modal -->
    <div class="modal fade" id="shareKeyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{% url 'share_private_key' %}">
          {% csrf_token %}
          <input type="hidden" name="key_id" id="modalKeyId" />
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Share Private Key via Email</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="email" class="form-label">Recipient Email</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  placeholder="someone@example.com"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Send Key</button>
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      const deleteModal = document.getElementById("statusErrorsModal");
      deleteModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const keyId = button.getAttribute("data-key-id");
        const form = document.getElementById("deleteForm");
        form.action = `/keys/delete/${keyId}/`; // Make sure this matches your URL pattern
      });

      const shareKeyModal = document.getElementById("shareKeyModal");
      shareKeyModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const keyId = button.getAttribute("data-key-id");
        document.getElementById("modalKeyId").value = keyId;
      });
    </script>
  </body>
</html>
